# 1. 基础编码
## 1.1 军规
1. **并发控制，默认使用悲观锁，一锁二判三更新，乐观引入需谨慎**
2. **幂等拦截，幂等新老要兼容，字段约束需一致，异常场景防击穿**
3. **状态推进，流转设计要完整，状态推进凭指令，业务终态不可逆**
4. **对象设置，成员变量慎赋值，引值引址需明晰，对象比较用equals**
5. **数据库表，SQL必须带字段，where条件有索引，索引不含隐式转**
6. **时间设置，关注时区和时令，避免设置当地值，string传值带时区**
7. **异常防御，请求校验防篡改，异常catch不能吞，线程对象清理好**
8. **代码质量，CR单测集成测，结果断言边界值，全量回归不能少**

## 1.2 案例讲解
### 1.2.1 并发控制
#### 典型故障
A、B两个并发线程，A推进状态为代扣完成，B由于TR超时，将状态推进到代扣异常且更新了下游幂等流水号，**造成重复代扣**
#### 经验
1. 业务上，并发问题引发故障往往伴随**幂等层层击穿**，二判逻辑必须包含业务规则检查和幂等检查
2. 原则上，非热点抢购的业务，推荐显示事务，并**采用悲观锁**，方便CR发现问题

### 1.2.2 幂等拦截
#### 典型故障
A、B两服务，A调用B，约定幂等字段为交易号，返回结果为状态：支付成功/失败（**少了异常**）    
1. A调用B，异常态下，上游A利用B幂等处理更换单据号进行业务恢复
2. B发现设计漏洞后，升级接口，幂等字段不变，但由于未通知到A条件变更，导致A业务**重复支付**
#### 经验
幂等不是单一系统的事情，做好自身幂等的同时，也要清楚**上下游幂等关系**

### 1.2.3 状态推进
#### 典型故障
支付悬挂后，导致**支付成功回执和关单请求并发**，由于关单逻辑未做状态判断（并发幂等处理），导致**支付成功单据被关闭**
#### 经验
状态机设计，尽可能保持状态简单，状态变更事件清晰，宁可拆分服务/事件，**不要状态设计过分复杂**

## 1.2.4 对象设置
#### 典型故障
1. 比较两个字符串用“==”
2. 修改方法传入string变量类型，且未return返回
#### 经验
1. 除了基础数据类型，其他逻辑判断不要用“==”，如果要判断对象，写一个sort和equals
2. 对于传值和传址，搞不清楚就不要写void方法

### 1.2.5 数据库表
#### 典型故障
1. 后台新增按产品ID查询交易明细功能，但where条件中仅产品ID一个字段，**未命中索引**，导致后台查询功能**拉跨线上数据库**
2. 按产品码进行数据更新，自定义SQL中，字符串参数**未加单引号**，导致最终**更新结果范围大于预期**
#### 经验
1. 索引和慢SQL的关系已经老生常谈，业务越来越复杂，单表数据越来越庞大，在项目建设过程中关注索引效果，复杂场景，可以找DBA协助CR
2. 项目上线了，查询走上索引了，也不能掉以轻心，还需要review，随着单表数据增加，是否导致执行计划变更，走到不同索引

### 1.2.6 时间设置
#### 典型故障
代表时间的string没有带时区信息，在转换为Date对象时，未正确处理时区信息，把代表北京时间的string按照洛杉矶时间进行转换，导致**比原有时间多15个小时**
#### 经验
string传递时间**一定要采用ISO标准时间**格式，带上时区信息，在处理时间string和Date对象的转换时要注意时区

### 1.2.7 异常防御
#### 典型故障
1. 根据商户ID查询的reset接口，仅校验是否登录，未校验商户ID，**导致用A商户登录可以查询任意商户的交易明细**
2. 安全服务化消息发送异常，系统catch异常后自动降级，但未做任务异常处置，导致后续**大量时间丢失**，未能及时复查，形成安全舆论事件
3. 上下文设置了压测字段，由于未清理，导致**正常业务数据走到压测路径**，引发业务下跌

### 1.2.8 代码质量
#### 典型故障
代码提交由于Linux和Windows的换行符不同，gitlab识别为整个文件替换，CR未识别具体改动的导致遗漏。本次提交将之前注释掉的问题代码带上线，导致故障
#### 经验
Pull Request尽量小，变更应是有效的变更，无效的变更应拒绝，CR要及时且负责

# 2. 中间件使用
## 2.1 军规
1. **消息使用，groupId要唯一，重复投递需关注，事务回查防悬挂**
2. **缓存设计，缓存击穿要兜底，过期设计去热点，存储容量需考虑**
3. **事务处理，悬挂告警要及时，严禁造成空提交，确保最终一致性**
4. **调度任务，调度重复要避免，捞取数据可配置，熔断能力需具备**
5. **限流配置，增量覆盖要分清，删除规则要小心，异常限流调算法**
6. **ZDAL使用，连接数量需评估，耗时上涨要警惕，FO机制来保障**
7. **RPC调用，接口ZoneRoute要注意，AntVip需配置，超时设置要谨慎**
8. **DRM使用，GetSet注解齐，生产推送上九州，推前内容勤对比**

# 3. 架构设计
## 3.1 军规
1. **防御编程，强弱依赖要合理，单点异常可切换，线程隔离和限流**
2. **网络调用，交互三态要牢记，错误定义要单一，未决处理遵协议**
3. **接口规约，字段约定要明确，业务含义要清晰，接口升级要兼容**
4. **LDC容灾，分Zone逻辑要清晰，FO能力需具备，灾备容量要对等**

## 3.2 案例讲解
### 3.2.1 防御编程
#### 典型故障
1. 支付链路依赖了A2系统，A2非关键业务压测**导致支付链路异常**
2. 业务限流只配置了一个整体的，因为一个活动非关键链路量级增大，**影响另一个关键业务**
#### 经验
1. **强弱依赖合理**，针对强依赖一般禁止高级别应用依赖低级别应用；针对弱依赖系统，注意捕获调用异常，合理设置超时时间
2. **业务环境隔离**，为了避免业务之间产生影响，必要的业务进行线程、限流值、连接池的隔离，甚至进行存储的隔离

### 3.2.2 网络调用
#### 典型故障
错误码未合理包装甚至直接抛出异常，甚至直接显示到用户界面上，导致疑问
#### 经验
1. 服务避免直接抛出异常，业务成功和失败均需要包装合理的**单一结果码**，能够通过结果码判断问题点
2. **客户端调用处理根据协议约定**，处理成功、失败和未知情况处理，根据业务需求进行重试、回滚、等待等处理

### 3.2.3 接口规约
#### 经验
1. 接口交互约定，业务相关字段必须**明确、单一**，相应接口注释清楚，确保交互双方业务理解一致
2. **禁止删除或修改接口方法、字段**，使用新增方法、字段方式进行升级扩充
3. 接口升级必须**兼容**当前输出，**避免**出现升级后字段输入产生**二义性**

### 3.2.4 LDC容灾
#### 经验
1. **根据业务特征和Idc特性设计各自的FO逻辑**，如**流水型**业务构造FO切换功能，状态型使用**ob三节点部署**，**czone设计多副本模式**实现单zone宕机的快速切换
2. 灾备机房需要**冗余双倍容量**，避免切换failover时，因容量不足导致雪崩，不但无法恢复，反而增加影响范围
3. 容灾能力要经验**定期演练**，以防容灾能力丢失

# 4. 客户端&前端
## 4.1 军规
1. **分工边界，复杂逻辑给后端，前端优先做展现，系分对齐不遗漏**
2. **稳定可靠，系统机型要兼容，异常边界需关注，判空保护不能少**
3. **性能体验，降低渲染复杂度，减少施压主线程，异步请求不阻塞**
4. **数据保护，个人信息先脱敏，资产信息可隐藏，日志隔离不外泄**

# 5. 资金安全
## 5.1 军规
1. **资金风险，认账时要对清楚，业务规则细分析，配置上下需一致**
2. **金额计算，注意币种元和分，计算使用Money类，外汇买卖方向对**
3. **核对设计，过程终态均核对，包含金融状态码，中间账户对余额**
4. **资金应急，上报止血要及时，数据捞取要复核，应急调账需审批**

# 6. 数据质量
## 6.1 军规
1. **业务保障，资损舆情录场景，失效保障用基线，上下协同保业务**
2. **引擎变更，变更方案要评审，灰度测试融演练，巡检免疫要到位**
3. **数据研发，研发规范需遵守，冒烟测试不可少，仿真灰度保稳定**
4. **监控核对，任务监控要添加，内容核对要重视，及时降噪禁麻木**
5. **风险治理，潜在风险配巡检，风险接收须治理，不治升级要权限**

## 6.2 典型案例
1. 任务发布未测试
2. 灰度测试不完整
3. 代码bug&应急处理不当

# 7. 生产变更
## 7.1 军规
1. **提前计划，下周变更本周理，重大高危需报备，沟通确认应有效**
2. **灰度分批，生产之前先灰度，分批操作控比例，关键业务须盯盘**
3. **防御检测，变更前后配校验，监控巡检覆盖全，防御规则勤演练**
4. **变更观察，恢复手段提前定，应急操作有人盯，出现问题变更停**
5. **变更执行，严格遵循三板斧，监控灰度可应急，违背规则要处罚**

# 8. 应急止血
## 8.1 军规
1. **应急值班，手机电脑随身带，电量网络要确保，暂时离开有备份**
2. **应急响应，接到报警快响应，出现风险速升级，预案执行需谨慎**
3. **应急过程，恢复止血第一位，高危操作先灰度，谨慎小心防扩大**
4. **应急手段，发现变更先回滚，容量不够降和限，容灾切换来兜底**
5. **应急建设，实战攻防日常练，定位自愈助提升，历史故障取经验**







