## 网关
- 网关解决了微服务下客户端调用、统一接入的问题
- 网关与代理的区别：代理是纯粹的数据透传，协议不会发生变化；网关除了数据透传，还会涉及协议的转换，比如客户端用 HTTP 请求，网关透传到下游可能转换成内部 RPC
- 网关核心功能：
    - 统一接入（高性能、高并发、高可靠、负载均衡）
    - 协议适配
    - 流量管控与容错（限流、降级、熔断）
    - 安全防护（防刷控制、黑白名单）
- 网关架构组成部分：
    - 注册中心，ZooKeeper
    - 数据异构缓存，Redis
    - 线程系统，NIO + Servlet3
    - 开放网关授权中心，OAuth 2.0 协议
- 网关重要的保障功能：降级、限流、熔断、线程池隔离、管道技术、热更新、异步

## 分布式
- 服务部署在多台服务器上，在服务器之上增加一层负载均衡，就形成了一个“集群”，Nginx
- CAP 理论：
    - C：一致性（Consistence），所有节点访问的都是同一份最新的数据副本
    - A：可用性（Availability），每次请求都能获取正确的响应（但不保证是最新的数据）
    - P：分区容错性（Tolerance of network Partition），将数据复制到分布式系统的不同节点上面，这样当某些节点因为网络原因不能通信时，请求还是可用的
    - **在满足分区容错性的前提下，一致性和可用性只能选择一个**，根本原因是网络故障或者某个服务器挂掉
- BASE 理论：
    - 基本可用（Basically Available）：分布式系统出故障时，允许损失一部分可用性，拿响应时间和功能上的损失来换取可用
    - 软状态（Soft State）：允许系统存在中间状态，这个中间状态不影响系统整体可用性（例如支付页的“支付中”）
    - 最终一致性（Eventual Consistency）：在允许出现中间状态的情况下，经过一段时间后，各项数据状态才最终达到一致性

- ACID 是传统数据库的设计思想，追求强一致性，BASE 是大型分布式系统场景下的设计思想，通过牺牲强一致性获得高可用性
- 分布式锁一般借助 Redis 和 ZooKeeper，前者适合高并发场景，后者适合对可靠性要求高但并发程度不高的场景
- “令牌桶”“漏桶算法”常被用在应用层级限流，作用于单机上。区别是“漏桶算法”能够强行限制数据的传输速度，而“令牌桶”在限制数据的平均传输速度外，还允许数据某种程度突发的传输，适合有突发特征的流量控制环境，例如秒杀系统
- 分布式限流需要一个公共的存储，所以最常用的是 Redis，但不能平滑流量。
- 大部分限流是单机上进行的，是业务场景层的限流，限流算法在内存中完成，性能高。如果要在流量入口处限流，可以在 Nginx 层利用 Redis 结合 lua 脚本来实现
- 常见衡量指标：
    - QPS：Queries Per Second，一台服务器每秒能响应的查询次数，衡量系统吞吐量
    - TPS：Transactions Per Second，一台服务器每秒处理事务的数量，用于评估数据库、交易系统的基准性能。一个完成事务包括用户请求服务器、服务器内部处理、服务器返回信息给用户这三个过程
    - RT：Response Time，客户端请求开始到客户端收到服务器响应经历的时间，包括请求发送、网络传输和服务器处理三部分时间
    - 并发数：系统能够同时处理的查询请求数量或事务数量

## 消息推送
- 一个消息推送系统涉及 Session 管理、心跳、消息接收、消息推送、消息追踪
- Netty 是一款成熟的网络通信框架

## RPC 之道
- RPC 指通过网络在跨进程的两台服务器之间传输信息，不用关心网络底层实现，使得调用远程服务就像本地调用系统内部方法一样方便
- RPC 基本调用过程：客户端发起一个 RPC 请求，本地调用 client stub 负责将调用的接口、方法和参数按照约定的协议进行序列化，然后由 RPC 框架的 RPCRuntime 实例通过 socket 传输到远程服务器上。远程服务器的 RPCRuntime 实例收到请求后通过 server stub 进行反序列化，发起最终的 server method 调用
- 良好的 RCP 框架要兼顾可靠性和易用性。可靠性要保证 IO、序列化的准确，还要考虑网络的不稳定性，心跳、网络断开等因素。易用性要考虑超时和重试机制，同步和异步调用等
- RPC 框架：Dubbo（阿里），Motan（新浪微博），Thrift（Facebook），gRPC（Google）
- 现在大部分 RPC 框架不是直接调用 socket，而是使用 Netty 将基础的网络代码进行封装
- 异步 RPC：成熟的 RPC 框架都会支持异步调用、异步监听、callback 调用
    - 异步调用：调用后利用 Future 去获取结果
    - 异步监听：注册一个监听类，XXXListener
    - 基于 TCP 全双工下长连接，服务器可以“调用”客户端 callback，还可以在服务端逻辑中实现“多次回调”

## 微服务
- 微服务特点
    - 一套小型服务，业务对应的支撑系统被拆分成一个个小的服务，各自有各自的生命周期
    - 以独立的进程运行
    - 采用轻量级的通信，例如 RPC
    - 围绕业务能力去构建，各自提供对业务能力的响应
    - 可以独立部署
    - 可以使用不同的开发语言，服务系统之间以 API 的形式进行交互
    - 可以使用不同的数据存储技术
  
## 容错
Hystrix 是一款容错框架，包含：线程池隔离、信号量隔离、熔断和降级回退。

### 降级与限流 
- 降级一般由统一配置中心的降级开关实现
- 降级不可以“暴力降级”，使得业务不可用。可以将一部分数据缓存起来作为托底
- 限流一般分为分布式限流和单机限流

### 线程池隔离
给不同的业务分配固定线程池，隔离其他业务，防止一个业务耗尽系统资源导致其他业务不可用

### 熔断
系统在运行过程中定时向对应的熔断器报告成功、失败、超时和拒绝的状态，熔断器维护计算统计的数据，根据这些统计信息来确定熔断器是否打开。如果打开，后续请求都会被截断，然后隔一段时间（例如 5s）尝试半开，放一部分请求进来，进行健康检查，如果恢复，则熔断器关闭，随后完全恢复调用。

### 大促备战
- 分离技术，将业务和服务隔离部署，线上运行和线下分析隔离
- 缓存技术，**对外暴露的接口一定不能直达数据库**，常用缓存是 Redis + JVM Cache
- SQL 优化，优化性能慢的 SQL，检查索引使用错误的情况
- 降级限流，分**屏蔽降级**和**容错降级**。前者对边缘业务直接切断 RPC 调用，返回空或异常，减少公共资源访问。后者有托底措施保证用户体验，例如本地缓存数据
- 性能压测，定位性能瓶颈